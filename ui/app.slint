import { VerticalBox, HorizontalBox, Button, CheckBox, GroupBox, ListView, StandardButton } from "std-widgets.slint";
import { Title } from "title.slint";
import { AddPersonPage, AddGroupPage, AddPersonToGroupPage } from "add_person.slint";
import { GroupsPanel } from "groups_panel.slint";
import { PersonData, GroupData, LogData, LogMinuteGroupData, LogDayGroupData } from "types.slint";
import "./../assets/fonts/Quicksand/static/Quicksand-Regular.ttf";
import "./../assets/fonts/Quicksand/static/Quicksand-Bold.ttf";

export component MainWindow inherits Window {
    title: "eWartownik";
    icon: @image-url("./../assets/images/logo.png");
    default-font-family: "Quicksand";
    // Default desktop size; on mobile the platform typically controls the surface size.
    // We still make touch targets larger below.
    width: 420px;
    height: 720px;

    in-out property <int> current_screen: 0; // 0 = main, 1 = persons, 2 = logs, 3 = setings
    in-out property <[PersonData]> people;
    in-out property <[PersonData]> people_out;
    in-out property <[bool]> people_checked;
    in-out property <[bool]> people_out_checked;
    in-out property <[GroupData]> groups;

    in-out property <[LogDayGroupData]> logs;

    in-out property <[PersonData]> persons_to_group;
    in-out property <[GroupData]> groups_to_group;
    in-out property <[string]> groups_to_group_names; // names for ComboBox
    in-out property <[PersonData]> filtered_persons_to_group; // persons excluding those already in selected group

    callback add_person_request(string, string, int, int);
    callback add_group_request(string);
    callback add_person_to_group_request(int, int);
    callback group_selection_changed(int);
    callback remove_person_request(int);

    callback main_group_clicked(int);
    callback main_person_toggled(int);
    callback main_get_in();
    callback main_get_out();
    
    function change_screen(index: int) {
        root.current_screen = index;
        nav_btn1.checked = index == 0;
        nav_btn2.checked = index == 1;
        nav_btn3.checked = index == 2;
        nav_btn4.checked = index == 3;
    }

    VerticalBox {
        spacing: 10px;
        padding: 8px;

        // -------------------------------
        // Main Screen
        if root.current_screen == 0: VerticalBox {
            spacing: 5px;

            Title { text: "eWartownik"; }
            GroupBox {
                title: @tr("CURRENT_PERSONNEL_LIST");

                VerticalBox {
                    spacing: 5px;
                    HorizontalBox {
                        VerticalBox {
                            Text { text: @tr("PERSONEL"); }
                            Text { text: @tr("IN"); }
                            state_persons_in := ListView {
                                for person[i] in root.people: CheckBox {
                                    text: person.rank + " " + person.surname + " " + person.name;
                                    height: 40px;
                                    checked: root.people_checked[i];
                                    toggled => { root.main_person_toggled(person.id); }
                                }
                            }
                            Text { text: @tr("OUT"); }
                            state_persons_out := ListView {
                                for person[i] in root.people_out: CheckBox {
                                    text: person.rank + " " + person.surname + " " + person.name;
                                    height: 40px;
                                    checked: root.people_out_checked[i];
                                    toggled => { root.main_person_toggled(person.id); }
                                }
                            }
                        }
                        VerticalBox {
                            Text { text: @tr("GROUPS"); }
                            Text { text: ""; }
                            state_groups_in := ListView {
                                for group in root.groups: Button {
                                    text: group.name;
                                    height: 40px;
                                    clicked => { root.main_group_clicked(group.id); }
                                }
                            }
                        }
                    }
                }
            }
            HorizontalBox {
                spacing: 10px;

                Button { text: @tr("GET_IN"); height: 44px; clicked => { root.main_get_in(); } }
                Button { text: @tr("GET_OUT"); height: 44px; clicked => { root.main_get_out(); } }
            }
        }

        // -------------------------------
        // Persons
        if root.current_screen == 1: Rectangle {
            
            VerticalLayout {
                spacing: 5px;

                Title { text: @tr("PERSONNEL_LIST"); }
                
                GroupsPanel {
                    groups: root.groups;
                }

                Button { text: @tr("ADD_PERSON"); height: 44px; clicked => { add_person_modal.visible = true; } }
                Button { text: @tr("ADD_GROUP"); height: 44px; clicked => { add_group_modal.visible = true; } }
                Button { text: @tr("ADD_PERSON_TO_GROUP"); height: 44px; clicked => {add_person_to_group_modal.visible = true} }
            }

            add_person_modal := Rectangle {
                visible: false;
                width: root.width;
                height: root.height;
                y: 0;
                background: #00000080;

                AddPersonPage {
                    x: (parent.width - self.width) / 2;
                    y: 50px;
                    
                    function clear() {
                        add_person_modal.visible = false;
                        self.name = "";
                        self.surname = "";
                        self.rank = 0;
                        self.methodology = 0;
                    }

                    exit => {
                        clear();
                    }

                    submit => {
                        root.add_person_request(self.name, self.surname, self.rank, self.methodology);
                        clear();
                    }
                }
            }

            add_group_modal := Rectangle {
                visible: false;
                width: root.width;
                height: root.height;
                y: 0;
                background: #00000080;

                AddGroupPage {
                    x: (parent.width - self.width) / 2;
                    y: 150px;
                    
                    function clear() {
                        add_group_modal.visible = false;
                        self.name = "";
                    }

                    exit => {
                        clear();
                    }

                    submit => {
                        root.add_group_request(self.name);
                        clear();
                    }
                }
            }

            add_person_to_group_modal := Rectangle {
                visible: false;
                width: root.width;
                height: root.height;
                y: 0;
                background: #00000080;

                AddPersonToGroupPage {
                    x: (parent.width - self.width) / 2;
                    y: 150px;

                    persons <=> persons_to_group;
                    filtered_persons <=> filtered_persons_to_group;
                    groups <=> groups_to_group;
                    groups_names <=> groups_to_group_names;

                    exit => {
                        add_person_to_group_modal.visible = false;
                    }

                    submit => {
                        // Pass real IDs instead of indices
                        if self.group >= 0 && self.group < groups_to_group.length && self.person >= 0 && self.person < persons_to_group.length {
                            root.add_person_to_group_request(persons_to_group[self.person].id, groups_to_group[self.group].id);
                        }
                        add_person_to_group_modal.visible = false;
                    }

                    // Forward child callback to MainWindow
                    group_selection_changed => { root.group_selection_changed(self.group); }
                }
            }
        }

        // -------------------------------
        // Logs
        if root.current_screen == 2: VerticalBox {
            spacing: 5px;

            Title { text: @tr("LOGS"); }
            ListView {
                for day_group in root.logs: GroupBox {
                    title: day_group.day;

                    // Make the day folder much bigger.
                    height: 420px;

                    VerticalBox {
                        spacing: 8px;

                        ListView {
                            height: 360px;
                            for minute_group in day_group.minutes: GroupBox {
                                title: minute_group.minute;

                                // Show at least ~5 entries before scrolling.
                                entries_view := ListView {
                                    height: 140px;
                                    for log in minute_group.entries: Rectangle {
                                        height: 44px;
                                        background: transparent;

                                        HorizontalBox {
                                            spacing: 10px;

                                            Rectangle {
                                                width: 14px;
                                                height: 14px;
                                                background: log.methodology;
                                                border-radius: 7px;
                                            }

                                            Text {
                                                text: log.rank + " " + log.surname + " " + log.name;
                                                vertical-alignment: center;
                                            }

                                            Text {
                                                text: log.is_in ? @tr("IN") : @tr("OUT");
                                                color: log.is_in ? #1f8b2e : #b3261e;
                                                vertical-alignment: center;
                                            }

                                            Text {
                                                text: log.timestamp;
                                                vertical-alignment: center;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        // -------------------------------
        // Settings
        if root.current_screen == 3: VerticalBox {
            spacing: 5px;

            Title { text: @tr("SETTINGS"); }
        }

        // -------------------------------
        // Navigation Bar
        Rectangle {
            height: 60px;
            width: root.width;

            HorizontalBox {
                padding: 0px;
                spacing: 0px;

                nav_btn1 := Button {
                    icon: @image-url("./../assets/images/home.svg");
                    colorize-icon: true;
                    checkable: true;
                    checked: true;
                    clicked => { change_screen(0); }
                }
                nav_btn2 := Button {
                    icon: @image-url("./../assets/images/group.svg");
                    colorize-icon: true;
                    checkable: true;
                    clicked => { change_screen(1); }
                }
                nav_btn3 := Button {
                    icon: @image-url("./../assets/images/script.svg");
                    colorize-icon: true;
                    checkable: true;
                    clicked => { change_screen(2); }
                }
                nav_btn4 := Button {
                    icon: @image-url("./../assets/images/cog.svg");
                    colorize-icon: true;
                    checkable: true;
                    clicked => { change_screen(3); }
                }
            }
        }
    }
}
